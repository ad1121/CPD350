<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Space Impact ‚Äî Vers√£o Completa</title>
<style>
  :root{
    --bg:#02030a;
    --panel:#071126;
    --accent:#4ee1ff;
    --muted:#9fb7c8;
  }
  body,html{
    height:100%;
    margin:0;
    background: radial-gradient(ellipse at center, #021224 0%, #000 70%);
    color:var(--muted);
    font-family: Inter, Roboto, Arial, sans-serif;
    -webkit-user-select:none;
    -ms-user-select:none;
    user-select:none;
  }

.wrap{
max-width:420px;
margin:12px auto;
padding:12px;
}

header{
text-align:center;
margin-bottom:8px;
}
h1{ margin:6px 0 2px; color:var(‚Äìaccent); font-size:20px;}
p.small{ margin:0 0 8px; font-size:12px; color:#9ab;}

.panel{
background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
border:1px solid rgba(255,255,255,0.03);
padding:10px;
border-radius:8px;
}

label{display:block; font-size:13px; margin:6px 0 3px;}
input[type=‚Äútext‚Äù]{ width:100%; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:var(‚Äìmuted); box-sizing:border-box; }
.row{ display:flex; gap:8px; }
button{
background:linear-gradient(180deg,var(‚Äìaccent), #2ac6e6);
color:#002;
border:none;
padding:8px 10px;
border-radius:6px;
cursor:pointer;
font-weight:600;
transition: transform 0.1s;
}
button:active{ transform: scale(0.95); }
button.ghost{
background:transparent; color:var(‚Äìmuted); border:1px solid rgba(255,255,255,0.04);
}
button.selected{
background:linear-gradient(180deg,var(‚Äìaccent), #2ac6e6);
color:#002;
}
.center{ text-align:center; }

#game-wrapper{
margin-top:12px;
display:none;
position:relative;
width:100%;
height:640px;
max-width:420px;
background:linear-gradient(#000 0%, rgba(0,0,0,0.6) 100%);
border-radius:8px;
overflow:hidden;
border:1px solid rgba(255,255,255,0.04);
}
canvas{ display:block; background:transparent; width:100%; height:100%; }

.hud{
position:absolute;
top:8px;
left:8px;
right:8px;
display:flex;
justify-content:space-between;
pointer-events:none;
}
.hud .left, .hud .right{ pointer-events:auto; display:flex; gap:6px; align-items:center; flex-wrap:wrap;}
.stat{ background:rgba(0,0,0,0.6); padding:6px 8px; border-radius:6px; font-size:12px; color:var(‚Äìmuted); }

.controls{
position:absolute;
bottom:10px;
left:10px;
right:10px;
display:flex;
justify-content:space-between;
pointer-events:none;
}
.touch-controls{ pointer-events:auto; display:flex; gap:8px; align-items:center; }
.btn-circle{ width:56px; height:56px; border-radius:50%; background:rgba(255,255,255,0.08); display:flex; align-items:center; justify-content:center; font-weight:700; color:var(‚Äìmuted); box-shadow:inset 0 -6px 12px rgba(0,0,0,0.4); touch-action: none; user-select: none; }
.btn-circle:active{ background:rgba(255,255,255,0.15); }
.btn-small{ padding:6px 10px; border-radius:6px; background:rgba(255,255,255,0.02); color:var(‚Äìmuted); }

.overlay{
position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.7));
backdrop-filter: blur(2px);
z-index:30;
color:var(‚Äìmuted);
}
.menu{
width:90%;
max-width:380px;
background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
padding:16px;
border-radius:10px;
border:1px solid rgba(255,255,255,0.03);
text-align:center;
}
.small-muted{ font-size:12px; color:#8aa; margin-top:8px; }

.scores{ max-height:160px; overflow:auto; text-align:left; margin-top:8px; }
.score-row{ display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,0.02); font-size:13px; color:var(‚Äìmuted); }

footer{ text-align:center; margin-top:12px; font-size:12px; color:#7f9;}
@media (max-width:420px){
#game-wrapper{ height:720px; }
}
</style>

</head>
<body>
<div class="wrap">
  <header>
    <h1>Space Impact ‚Äî Remake</h1>
    <p class="small">5 fases completas com power-ups ‚Ä¢ Controles: teclado ou toque</p>
  </header>

  <div class="panel" id="setup-panel">
    <label for="nick">Seu nick:</label>
    <input id="nick" type="text" placeholder="Ex: Astro123" maxlength="16" />

```
<label>Escolha o controle:</label>
<div class="row">
  <button id="control-key">Setas (teclado)</button>
  <button id="control-touch" class="ghost">Toque (dedo)</button>
</div>

<label style="margin-top:8px;">Op√ß√µes:</label>
<div class="row">
  <button id="btn-start">Iniciar Jogo</button>
  <button id="btn-show-scores" class="ghost">Ver Placar</button>
</div>
<div class="row" style="margin-top:4px;">
  <button id="btn-clear-scores" class="ghost">Limpar placares</button>
</div>
<p class="small-muted">Dica: Use "Full" para tela cheia. Ao finalizar, baixe o JSON com seus recordes!</p>
```

  </div>

  <div id="game-wrapper" class="panel">
    <canvas id="gameCanvas" width="480" height="800"></canvas>

```
<div class="hud">
  <div class="left">
    <div class="stat" id="stat-nick">Nick: ‚Äî</div>
    <div class="stat" id="stat-lives">‚ù§Ô∏è 3</div>
    <div class="stat" id="stat-power">Power: ‚Äî</div>
  </div>
  <div class="right">
    <div class="stat" id="stat-level">Fase: 1/5</div>
    <div class="stat" id="stat-score">0</div>
    <button id="btn-full" class="btn-small">Full</button>
  </div>
</div>

<div class="controls">
  <div class="touch-controls" id="touch-left" style="display:none;">
    <div class="btn-circle" id="btn-up">‚ñ≤</div>
    <div class="btn-circle" id="btn-down">‚ñº</div>
  </div>
  <div style="pointer-events:none;"></div>
  <div class="touch-controls" id="touch-right" style="display:none;">
    <div class="btn-circle" id="btn-shot">‚óè</div>
  </div>
</div>

<div id="overlay-menu" class="overlay" style="display:none;">
  <div class="menu">
    <h2 id="menu-title">Pronto para voar?</h2>
    <p id="menu-sub" class="small-muted">Nome: ‚Äî | Controle: ‚Äî</p>
    <div style="margin-top:12px;">
      <button id="menu-play">Come√ßar</button>
      <button id="menu-back" class="ghost">Voltar</button>
    </div>
    <div class="small-muted" style="margin-top:8px;">Objetivo: sobreviva √†s 5 fases e colete power-ups!</div>
  </div>
</div>

<div id="overlay-gameover" class="overlay" style="display:none;">
  <div class="menu">
    <h2 id="go-title">Game Over</h2>
    <p id="go-text" class="small-muted">Voc√™ marcou <span id="final-score">0</span> pontos na fase <span id="final-level">1</span>.</p>
    <div style="margin-top:10px;">
      <button id="go-restart">Jogar novamente</button>
      <button id="go-menu" class="ghost">Voltar ao menu</button>
    </div>
    <div class="small-muted" style="margin-top:8px;">
      <button id="download-json" class="ghost">Baixar JSON de placares</button>
    </div>
  </div>
</div>
```

  </div>

  <div id="scores-panel" class="panel" style="display:none; margin-top:12px;">
    <h3>Placar salvo (localStorage)</h3>
    <div class="scores" id="scores-list"></div>
    <div style="margin-top:8px; text-align:center;">
      <button id="download-json-2">Baixar JSON</button>
      <button id="close-scores" class="ghost">Fechar</button>
    </div>
  </div>

  <footer>
    <small>Feito com ‚ô• ‚Äî Space Impact Remake</small>
  </footer>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let GAME = {
  running:false,
  control:'keys',
  nick:'Player',
  lives:3,
  score:0,
  level:1,
  maxLevel:5,
  width:480,
  height:800,
  lastTime:0,
  enemyTimer:0,
  enemyInterval:1500,
  bullets:[],
  enemies:[],
  powerups:[],
  particles:[],
  player:null,
  powerActive:null,
  powerTimer:0,
  invulnerable:false,
  invulnerableTimer:0
};

const setupPanel = document.getElementById('setup-panel');
const overlayMenu = document.getElementById('overlay-menu');
const overlayGameover = document.getElementById('overlay-gameover');
const scoresPanel = document.getElementById('scores-panel');
const scoresList = document.getElementById('scores-list');

const statNick = document.getElementById('stat-nick');
const statLives = document.getElementById('stat-lives');
const statScore = document.getElementById('stat-score');
const statLevel = document.getElementById('stat-level');
const statPower = document.getElementById('stat-power');

const btnFull = document.getElementById('btn-full');
const btnControlKey = document.getElementById('control-key');
const btnControlTouch = document.getElementById('control-touch');
const inputNick = document.getElementById('nick');
const btnStart = document.getElementById('btn-start');
const btnShowScores = document.getElementById('btn-show-scores');
const btnClearScores = document.getElementById('btn-clear-scores');

const touchLeft = document.getElementById('touch-left');
const touchRight = document.getElementById('touch-right');
const btnUp = document.getElementById('btn-up');
const btnDown = document.getElementById('btn-down');
const btnShot = document.getElementById('btn-shot');

const menuPlay = document.getElementById('menu-play');
const menuBack = document.getElementById('menu-back');
const menuSub = document.getElementById('menu-sub');
const menuTitle = document.getElementById('menu-title');

const goRestart = document.getElementById('go-restart');
const goMenu = document.getElementById('go-menu');
const downloadJsonBtn = document.getElementById('download-json');
const finalScoreSpan = document.getElementById('final-score');
const finalLevelSpan = document.getElementById('final-level');

const downloadJsonBtn2 = document.getElementById('download-json-2');
const closeScores = document.getElementById('close-scores');

let chosenControl = 'keys';

const STORAGE_KEY = 'space_impact_scores_v1';

function loadScores(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : [];
  }catch(e){ return []; }
}
function saveScoreEntry(entry){
  const arr = loadScores();
  arr.push(entry);
  arr.sort((a,b) => b.score - a.score);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr.slice(0, 50)));
}
function clearScores(){
  localStorage.removeItem(STORAGE_KEY);
}

function downloadJSON(filename='scores.json'){
  const data = loadScores();
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
}

function rand(min,max){ return Math.random()*(max-min)+min; }
function now(){ return performance.now(); }

function createPlayer(){
  return {
    x:80,
    y:GAME.height/2,
    w:32,
    h:20,
    speed:350,
    cooldown:0,
    fireRate:250,
    color:'#6bf',
    shield:false
  };
}

function spawnEnemy(type='basic'){
  const configs = {
    basic: {w:28, h:20, speed:rand(140,200), hp:1, points:50, color:'#ffa94d'},
    fast: {w:20, h:16, speed:rand(260,340), hp:1, points:80, color:'#f9a'},
    big: {w:48, h:36, speed:rand(80,130), hp:3, points:150, color:'#f55'},
    zigzag: {w:24, h:18, speed:rand(160,220), hp:2, points:100, color:'#af5'}
  };
  
  const cfg = configs[type] || configs.basic;
  const y = rand(30, GAME.height - 30);
  
  GAME.enemies.push({
    x: GAME.width + 40,
    y,
    w:cfg.w,
    h:cfg.h,
    speed:cfg.speed,
    hp:cfg.hp,
    maxHp:cfg.hp,
    type,
    points:cfg.points,
    color:cfg.color,
    zigzagOffset: type==='zigzag' ? rand(0, Math.PI*2) : 0
  });
}

function spawnPowerup(){
  const types = ['rapid','shield','health'];
  const t = types[Math.floor(Math.random()*types.length)];
  GAME.powerups.push({
    x: GAME.width + 40,
    y: rand(60, GAME.height-60),
    size:24,
    type: t,
    rotation: 0
  });
}

function fireBullet(fromX, fromY, speed=500){
  GAME.bullets.push({
    x: fromX,
    y: fromY,
    r:4,
    speed
  });
}

function createParticle(x, y, color='#fff'){
  for(let i=GAME.enemies.length-1;i>=0;i--){
    const e = GAME.enemies[i];
    e.x -= e.speed * (dt/1000);
    
    if(e.type === 'zigzag'){
      e.zigzagOffset += dt * 0.003;
      e.y += Math.sin(e.zigzagOffset) * 2;
    }
    
    ctx.save();
    ctx.translate(e.x, e.y);
    ctx.fillStyle = e.color;
    ctx.beginPath();
    ctx.ellipse(0,0,e.w/2,e.h/2,0,0,Math.PI*2);
    ctx.fill();
    ctx.strokeStyle = 'rgba(0,0,0,0.3)';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    if(e.hp < e.maxHp){
      ctx.fillStyle = 'rgba(255,0,0,0.6)';
      ctx.fillRect(-e.w/2, -e.h/2 - 6, e.w * (e.hp/e.maxHp), 3);
    }
    ctx.restore();

    for(let j=GAME.bullets.length-1;j>=0;j--){
      const b = GAME.bullets[j];
      if(rectColl({x:b.x-b.r,y:b.y-b.r,w:b.r*2,h:b.r*2}, {x:e.x-e.w/2,y:e.y-e.h/2,w:e.w,h:e.h})){
        e.hp -= 1;
        GAME.bullets.splice(j,1);
        createParticle(b.x, b.y, e.color);
        
        if(e.hp <= 0){
          GAME.enemies.splice(i,1);
          GAME.score += e.points;
          createParticle(e.x, e.y, e.color);
          if(Math.random() < 0.12) spawnPowerup();
          updateHUD();
        }
        break;
      }
    }

    if(!GAME.invulnerable && rectColl({x:p.x - p.w/2, y:p.y - p.h/2, w:p.w, h:p.h}, {x:e.x-e.w/2,y:e.y-e.h/2,w:e.w,h:e.h})){
      if(GAME.player.shield){
        GAME.enemies.splice(i,1);
        GAME.score += Math.floor(e.points * 0.5);
        createParticle(e.x, e.y, e.color);
        updateHUD();
      } else {
        GAME.enemies.splice(i,1);
        GAME.lives--;
        GAME.invulnerable = true;
        GAME.invulnerableTimer = 2000;
        createParticle(e.x, e.y, '#f55');
        updateHUD();
        
        if(GAME.lives <= 0){
          gameOver();
          return;
        }
      }
    }

    if(e.x < -100){
      GAME.enemies.splice(i,1);
    }
  }

  for(let i=GAME.powerups.length-1;i>=0;i--){
    const pu = GAME.powerups[i];
    pu.x -= 100 * (dt/1000);
    pu.rotation += dt * 0.003;
    
    ctx.save();
    ctx.translate(pu.x, pu.y);
    ctx.rotate(pu.rotation);
    
    const colors = {
      rapid: '#9f5',
      shield: '#5ff',
      health: '#f77'
    };
    
    ctx.fillStyle = colors[pu.type] || '#fff';
    ctx.beginPath();
    ctx.arc(0,0, pu.size/2, 0, Math.PI*2);
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.4)';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.font = 'bold 10px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(pu.type[0].toUpperCase(), 0, 0);
    
    ctx.restore();

    if(rectColl({x:p.x - p.w/2, y:p.y - p.h/2, w:p.w, h:p.h}, {x:pu.x-pu.size/2,y:pu.y-pu.size/2,w:pu.size,h:pu.size})){
      if(pu.type === 'health'){
        GAME.lives = Math.min(5, GAME.lives + 1);
      } else {
        GAME.powerActive = pu.type;
        GAME.powerTimer = 8000 + (GAME.level*1000);
        if(pu.type === 'shield'){
          GAME.player.shield = true;
        }
      }
      GAME.powerups.splice(i,1);
      createParticle(pu.x, pu.y, colors[pu.type]);
      updateHUD();
    }

    if(pu.x < -50) GAME.powerups.splice(i,1);
  }

  if(GAME.powerActive){
    GAME.powerTimer -= dt;
    if(GAME.powerTimer <= 0){
      if(GAME.powerActive === 'shield') GAME.player.shield = false;
      GAME.powerActive = null;
    }
  }

  if(GAME.invulnerable){
    GAME.invulnerableTimer -= dt;
    if(GAME.invulnerableTimer <= 0){
      GAME.invulnerable = false;
    }
  }

  for(let i=GAME.particles.length-1;i>=0;i--){
    const part = GAME.particles[i];
    part.x += part.vx * (dt/1000);
    part.y += part.vy * (dt/1000);
    part.life -= dt/1000;
    
    const alpha = part.life / part.maxLife;
    ctx.fillStyle = part.color + Math.floor(alpha * 255).toString(16).padStart(2, '0');
    ctx.fillRect(part.x, part.y, part.size, part.size);
    
    if(part.life <= 0) GAME.particles.splice(i,1);
  }

  drawShip(GAME.player.x, GAME.player.y, GAME.player.w, GAME.player.h, GAME.player.shield);

  const scoreThreshold = GAME.level * 1000;
  if(GAME.score >= scoreThreshold){
    nextLevel();
    return;
  }

  updateHUD();
  requestAnimationFrame(gameLoop);
}

btnControlKey.addEventListener('click', ()=>{
  chosenControl = 'keys';
  btnControlKey.classList.remove('ghost');
  btnControlKey.classList.add('selected');
  btnControlTouch.classList.add('ghost');
  btnControlTouch.classList.remove('selected');
});

btnControlTouch.addEventListener('click', ()=>{
  chosenControl = 'touch';
  btnControlTouch.classList.remove('ghost');
  btnControlTouch.classList.add('selected');
  btnControlKey.classList.add('ghost');
  btnControlKey.classList.remove('selected');
});

btnStart.addEventListener('click', startGame);

menuBack.addEventListener('click', ()=>{
  overlayMenu.style.display='none';
  setupPanel.style.display='block';
  document.getElementById('game-wrapper').style.display='none';
});

menuPlay.addEventListener('click', beginPlay);

btnFull.addEventListener('click', ()=>{
  const el = document.getElementById('game-wrapper');
  if(!document.fullscreenElement){
    el.requestFullscreen?.() || el.webkitRequestFullscreen?.();
  } else {
    document.exitFullscreen?.() || document.webkitExitFullscreen?.();
  }
});

btnShowScores.addEventListener('click', ()=>{
  updateScoresList();
  scoresPanel.style.display='block';
});

closeScores.addEventListener('click', ()=> scoresPanel.style.display='none');

btnClearScores.addEventListener('click', ()=>{
  if(confirm('Limpar todos os placares salvos?')){
    clearScores();
    updateScoresList();
    alert('Placar limpo!');
  }
});

goRestart.addEventListener('click', ()=>{
  overlayGameover.style.display='none';
  resetGame();
  GAME.player = createPlayer();
  
  if(GAME.control === 'touch'){
    touchLeft.style.display='flex';
    touchRight.style.display='flex';
  } else {
    touchLeft.style.display='none';
    touchRight.style.display='none';
  }
  
  GAME.running = true;
  GAME.lastTime = now();
  requestAnimationFrame(gameLoop);
});

goMenu.addEventListener('click', ()=>{
  overlayGameover.style.display='none';
  document.getElementById('game-wrapper').style.display='none';
  setupPanel.style.display='block';
  scoresPanel.style.display='none';
});

downloadJsonBtn.addEventListener('click', ()=> downloadJSON('scores-space-impact.json'));
downloadJsonBtn2.addEventListener('click', ()=> downloadJSON('scores-space-impact.json'));

function updateScoresList(){
  const arr = loadScores();
  if(arr.length === 0){
    scoresList.innerHTML = '<div class="score-row">Nenhum placar salvo ainda.</div>';
    return;
  }
  scoresList.innerHTML = '';
  arr.slice(0, 20).forEach((s)=>{
    const row = document.createElement('div');
    row.className = 'score-row';
    const left = document.createElement('div');
    left.textContent = `${s.nick} ‚Äî Fase ${s.level}`;
    const right = document.createElement('div');
    right.textContent = `${s.score} pts`;
    row.appendChild(left);
    row.appendChild(right);
    scoresList.appendChild(row);
  });
}

inputNick.addEventListener('input', ()=>{
  menuSub.textContent = `Nome: ${inputNick.value||'Player'} | Controle: ${chosenControl==='keys'?'Setas':'Toque'}`;
});

document.body.addEventListener('touchmove', function(e){
  if(GAME.running && GAME.control==='touch') e.preventDefault();
}, {passive:false});

updateScoresList();
updateHUD();

window.addEventListener('load', ()=>{
  btnControlKey.classList.add('selected');
});(let i=0; i<6; i++){
    GAME.particles.push({
      x, y,
      vx: rand(-100, 100),
      vy: rand(-100, 100),
      life: rand(0.3, 0.6),
      maxLife: 0.6,
      color,
      size: rand(2, 4)
    });
  }
}

function resetGame(){
  GAME.running = false;
  GAME.lives = 3;
  GAME.score = 0;
  GAME.level = 1;
  GAME.enemyInterval = 1500;
  GAME.bullets = [];
  GAME.enemies = [];
  GAME.powerups = [];
  GAME.particles = [];
  GAME.player = createPlayer();
  GAME.lastTime = now();
  GAME.enemyTimer = 0;
  GAME.powerActive = null;
  GAME.powerTimer = 0;
  GAME.invulnerable = false;
  GAME.invulnerableTimer = 0;
  updateHUD();
}

function startGame(){
  const nickVal = (inputNick.value || 'Player').trim().slice(0,16);
  GAME.nick = nickVal || 'Player';
  GAME.control = chosenControl;
  resetGame();
  setupPanel.style.display='none';
  document.getElementById('game-wrapper').style.display='block';
  overlayMenu.style.display='flex';
  menuTitle.textContent = 'Pronto para voar?';
  menuSub.textContent = `Nome: ${GAME.nick} | Controle: ${GAME.control === 'keys'? 'Setas' : 'Toque'}`;
  GAME.running = false;
}

function beginPlay(){
  overlayMenu.style.display='none';
  if(GAME.control === 'touch'){
    touchLeft.style.display='flex';
    touchRight.style.display='flex';
  } else {
    touchLeft.style.display='none';
    touchRight.style.display='none';
  }
  GAME.running = true;
  GAME.lastTime = now();
  GAME.enemyTimer = 0;
  requestAnimationFrame(gameLoop);
}

function gameOver(){
  GAME.running = false;
  overlayGameover.style.display='flex';
  finalScoreSpan.textContent = GAME.score;
  finalLevelSpan.textContent = GAME.level;
  
  saveScoreEntry({
    nick: GAME.nick,
    score: GAME.score,
    level: GAME.level,
    date: new Date().toISOString()
  });
  updateScoresList();
}

function nextLevel(){
  if(GAME.level >= GAME.maxLevel){
    GAME.running = false;
    overlayGameover.style.display='flex';
    document.getElementById('go-title').textContent = 'üéâ Voc√™ venceu!';
    document.getElementById('go-text').innerHTML = `Parab√©ns, <strong>${GAME.nick}</strong>!<br>Pontua√ß√£o final: <strong>${GAME.score}</strong>`;
    finalScoreSpan.textContent = GAME.score;
    finalLevelSpan.textContent = GAME.level;
    
    saveScoreEntry({
      nick: GAME.nick,
      score: GAME.score,
      level: GAME.level,
      date: new Date().toISOString()
    });
    return;
  }
  
  GAME.level++;
  GAME.enemyInterval = Math.max(400, GAME.enemyInterval * 0.75);
  GAME.lives = Math.min(5, GAME.lives + 1);
  GAME.enemies = [];
  GAME.powerups = [];
  GAME.bullets = [];
  
  GAME.running = false;
  overlayMenu.style.display='flex';
  menuTitle.textContent = `Fase ${GAME.level}`;
  menuSub.textContent = 'Prepare-se! A dificuldade aumentou.';
  
  setTimeout(()=> {
    overlayMenu.style.display='none';
    GAME.running=true;
    GAME.lastTime = now();
    requestAnimationFrame(gameLoop);
  }, 2000);
}

function updateHUD(){
  statNick.textContent = `${GAME.nick}`;
  statLives.textContent = `‚ù§Ô∏è ${GAME.lives}`;
  statScore.textContent = `${GAME.score}`;
  statLevel.textContent = `Fase: ${GAME.level}/${GAME.maxLevel}`;
  
  if(GAME.powerActive){
    const timeLeft = Math.ceil(GAME.powerTimer/1000);
    statPower.textContent = `${GAME.powerActive.toUpperCase()} (${timeLeft}s)`;
    statPower.style.background = 'rgba(100,220,100,0.3)';
  } else {
    statPower.textContent = 'Power: ‚Äî';
    statPower.style.background = 'rgba(0,0,0,0.6)';
  }
}

function rectColl(a,b){
  return a.x < b.x + b.w &&
         a.x + (a.w||a.r*2) > b.x &&
         a.y < b.y + (b.h||b.size) &&
         (a.y + (a.h||a.r*2)) > b.y;
}

let keyState = {up:false, down:false, shoot:false};

window.addEventListener('keydown', e=>{
  if(GAME.control !== 'keys') return;
  if(e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') keyState.up = true;
  if(e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') keyState.down = true;
  if(e.key === ' ' || e.key === 'ArrowRight') {
    keyState.shoot = true;
    e.preventDefault();
  }
});

window.addEventListener('keyup', e=>{
  if(GAME.control !== 'keys') return;
  if(e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') keyState.up = false;
  if(e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') keyState.down = false;
  if(e.key === ' ' || e.key === 'ArrowRight') keyState.shoot = false;
});

let touchDrag = {active:false, startY:0, lastY:0};

canvas.addEventListener('touchstart', e=>{
  if(GAME.control !== 'touch') return;
  const t = e.touches[0];
  touchDrag.active = true;
  touchDrag.startY = t.clientY;
  touchDrag.lastY = t.clientY;
  e.preventDefault();
}, {passive:false});

canvas.addEventListener('touchmove', e=>{
  if(GAME.control !== 'touch' || !touchDrag.active) return;
  const t = e.touches[0];
  touchDrag.lastY = t.clientY;
  e.preventDefault();
}, {passive:false});

canvas.addEventListener('touchend', e=>{
  touchDrag.active = false;
  e.preventDefault();
}, {passive:false});

btnUp.addEventListener('touchstart', (e)=>{ keyState.up = true; e.preventDefault(); }, {passive:false});
btnUp.addEventListener('touchend', (e)=>{ keyState.up = false; e.preventDefault(); }, {passive:false});
btnDown.addEventListener('touchstart', (e)=>{ keyState.down = true; e.preventDefault(); }, {passive:false});
btnDown.addEventListener('touchend', (e)=>{ keyState.down = false; e.preventDefault(); }, {passive:false});
btnShot.addEventListener('touchstart', (e)=>{ keyState.shoot = true; e.preventDefault(); }, {passive:false});
btnShot.addEventListener('touchend', (e)=>{ keyState.shoot = false; e.preventDefault(); }, {passive:false});

canvas.addEventListener('mousedown', (e)=>{
  if(GAME.control==='touch' && GAME.running){
    keyState.shoot = true;
    setTimeout(()=> keyState.shoot=false, 150);
  }
});

function drawShip(x,y,w,h,shield=false){
  ctx.save();
  ctx.translate(x,y);
  
  ctx.beginPath();
  ctx.moveTo(-w/2, -h/2);
  ctx.lineTo(w/2, 0);
  ctx.lineTo(-w/2, h/2);
  ctx.closePath();
  ctx.fillStyle = GAME.invulnerable && Math.floor(now()/100)%2 ? 'rgba(107,187,255,0.5)' : '#6bf';
  ctx.fill();
  ctx.strokeStyle = '#4dd';
  ctx.lineWidth = 1;
  ctx.stroke();
  
  if(shield){
    ctx.beginPath();
    ctx.arc(0,0, Math.max(w,h)*0.9, 0, Math.PI*2);
    ctx.strokeStyle = 'rgba(100,220,255,0.5)';
    ctx.lineWidth = 3;
    ctx.stroke();
  }
  ctx.restore();
}

let stars = [];
for(let i=0; i<100; i++){
  stars.push({
    x: rand(0, 480),
    y: rand(0, 800),
    speed: rand(20, 80),
    size: rand(1, 2.5),
    brightness: rand(0.3, 1)
  });
}

function drawBackground(dt){
  ctx.fillStyle = '#000';
  ctx.fillRect(0,0, GAME.width, GAME.height);
  
  stars.forEach(s => {
    s.x -= s.speed * (dt/1000);
    if(s.x < -5) {
      s.x = GAME.width + 5;
      s.y = rand(0, GAME.height);
    }
    ctx.fillStyle = `rgba(255,255,255,${s.brightness})`;
    ctx.fillRect(s.x, s.y, s.size, s.size);
  });
}

function gameLoop(t){
  if(!GAME.running) return;
  const dt = Math.min(40, t - GAME.lastTime);
  GAME.lastTime = t;

  drawBackground(dt);

  GAME.enemyTimer += dt;
  if(GAME.enemyTimer > GAME.enemyInterval){
    GAME.enemyTimer = 0;
    
    const roll = Math.random();
    if(GAME.level === 1){
      spawnEnemy('basic');
    } else if(GAME.level === 2){
      spawnEnemy(roll < 0.7 ? 'basic' : 'fast');
    } else if(GAME.level === 3){
      spawnEnemy(roll < 0.4 ? 'basic' : (roll < 0.7 ? 'fast' : 'zigzag'));
    } else if(GAME.level === 4){
      spawnEnemy(roll < 0.3 ? 'basic' : (roll < 0.6 ? 'fast' : (roll < 0.85 ? 'zigzag' : 'big')));
    } else {
      spawnEnemy(roll < 0.25 ? 'basic' : (roll < 0.5 ? 'fast' : (roll < 0.8 ? 'zigzag' : 'big')));
      if(Math.random() < 0.4) spawnEnemy('fast');
    }
  }

  if(Math.random() < 0.0015 + GAME.level*0.0005){
    spawnPowerup();
  }

  const p = GAME.player;
  if(GAME.control === 'keys'){
    if(keyState.up) p.y -= p.speed * (dt/1000);
    if(keyState.down) p.y += p.speed * (dt/1000);
  } else {
    if(touchDrag.active){
      const rect = canvas.getBoundingClientRect();
      const canvasY = ((touchDrag.lastY - rect.top) / rect.height) * GAME.height;
      p.y += (canvasY - p.y) * 0.2;
    } else {
      if(keyState.up) p.y -= p.speed * (dt/1000);
      if(keyState.down) p.y += p.speed * (dt/1000);
    }
  }
  p.y = Math.max(20, Math.min(GAME.height-20, p.y));

  p.cooldown -= dt;
  const canShoot = p.cooldown <= 0;
  if(keyState.shoot && canShoot){
    fireBullet(p.x + 18, p.y, 550);
    if(GAME.powerActive === 'rapid'){
      p.cooldown = p.fireRate * 0.3;
    } else {
      p.cooldown = p.fireRate;
    }
  }

  for(let i=GAME.bullets.length-1;i>=0;i--){
    const b = GAME.bullets[i];
    b.x += b.speed * (dt/1000);
    
    ctx.beginPath();
    ctx.fillStyle = '#fffb8f';
    ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
    ctx.fill();
    
    if(b.x > GAME.width + 20) GAME.bullets.splice(i,1);
  }
  for(let i=GAME.enemies.length-1;i>=0;i--){
    const e = GAME.enemies[i];
    e.x -= e.speed * (dt/1000);
    
    if(e.type === 'zigzag'){
      e.zigzagOffset += dt * 0.003;
      e.y += Math.sin(e.zigzagOffset) * 2;
    }
    
    ctx.save();
    ctx.translate(e.x, e.y);
    ctx.fillStyle = e.color;
    ctx.beginPath();
    ctx.ellipse(0,0,e.w/2,e.h/2,0,0,Math.PI*2);
    ctx.fill();
    ctx.strokeStyle = 'rgba(0,0,0,0.3)';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    if(e.hp < e.maxHp){
      ctx.fillStyle = 'rgba(255,0,0,0.6)';
      ctx.fillRect(-e.w/2, -e.h/2 - 6, e.w * (e.hp/e.maxHp), 3);
    }
    ctx.restore();

    for(let j=GAME.bullets.length-1;j>=0;j--){
      const b = GAME.bullets[j];
      if(rectColl({x:b.x-b.r,y:b.y-b.r,w:b.r*2,h:b.r*2}, {x:e.x-e.w/2,y:e.y-e.h/2,w:e.w,h:e.h})){
        e.hp -= 1;
        GAME.bullets.splice(j,1);
        createParticle(b.x, b.y, e.color);
        
        if(e.hp <= 0){
          GAME.enemies.splice(i,1);
          GAME.score += e.points;
          createParticle(e.x, e.y, e.color);
          if(Math.random() < 0.12) spawnPowerup();
          updateHUD();
        }
        break;
      }
    }

    if(!GAME.invulnerable && rectColl({x:p.x - p.w/2, y:p.y - p.h/2, w:p.w, h:p.h}, {x:e.x-e.w/2,y:e.y-e.h/2,w:e.w,h:e.h})){
      if(GAME.player.shield){
        GAME.enemies.splice(i,1);
        GAME.score += Math.floor(e.points * 0.5);
        createParticle(e.x, e.y, e.color);
        updateHUD();
      } else {
        GAME.enemies.splice(i,1);
        GAME.lives--;
        GAME.invulnerable = true;
        GAME.invulnerableTimer = 2000;
        createParticle(e.x, e.y, '#f55');
        updateHUD();
        
        if(GAME.lives <= 0){
          gameOver();
          return;
        }
      }
    }

    if(e.x < -100){
      GAME.enemies.splice(i,1);
    }
  }

  for(let i=GAME.powerups.length-1;i>=0;i--){
    const pu = GAME.powerups[i];
    pu.x -= 100 * (dt/1000);
    pu.rotation += dt * 0.003;
    
    ctx.save();
    ctx.translate(pu.x, pu.y);
    ctx.rotate(pu.rotation);
    
    const colors = {
      rapid: '#9f5',
      shield: '#5ff',
      health: '#f77'
    };
    
    ctx.fillStyle = colors[pu.type] || '#fff';
    ctx.beginPath();
    ctx.arc(0,0, pu.size/2, 0, Math.PI*2);
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.4)';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.font = 'bold 10px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(pu.type[0].toUpperCase(), 0, 0);
    
    ctx.restore();

    if(rectColl({x:p.x - p.w/2, y:p.y - p.h/2, w:p.w, h:p.h}, {x:pu.x-pu.size/2,y:pu.y-pu.size/2,w:pu.size,h:pu.size})){
      if(pu.type === 'health'){
        GAME.lives = Math.min(5, GAME.lives + 1);
      } else {
        GAME.powerActive = pu.type;
        GAME.powerTimer = 8000 + (GAME.level*1000);
        if(pu.type === 'shield'){
          GAME.player.shield = true;
        }
      }
      GAME.powerups.splice(i,1);
      createParticle(pu.x, pu.y, colors[pu.type]);
      updateHUD();
    }

    if(pu.x < -50) GAME.powerups.splice(i,1);
  }

  if(GAME.powerActive){
    GAME.powerTimer -= dt;
    if(GAME.powerTimer <= 0){
      if(GAME.powerActive === 'shield') GAME.player.shield = false;
      GAME.powerActive = null;
    }
  }

  if(GAME.invulnerable){
    GAME.invulnerableTimer -= dt;
    if(GAME.invulnerableTimer <= 0){
      GAME.invulnerable = false;
    }
  }

  for(let i=GAME.particles.length-1;i>=0;i--){
    const part = GAME.particles[i];
    part.x += part.vx * (dt/1000);
    part.y += part.vy * (dt/1000);
    part.life -= dt/1000;
    
    const alpha = part.life / part.maxLife;
    ctx.fillStyle = part.color + Math.floor(alpha * 255).toString(16).padStart(2, '0');
    ctx.fillRect(part.x, part.y, part.size, part.size);
    
    if(part.life <= 0) GAME.particles.splice(i,1);
  }

  drawShip(GAME.player.x, GAME.player.y, GAME.player.w, GAME.player.h, GAME.player.shield);

  const scoreThreshold = GAME.level * 1000;
  if(GAME.score >= scoreThreshold){
    nextLevel();
    return;
  }

  updateHUD();
  requestAnimationFrame(gameLoop);
}

btnControlKey.addEventListener('click', ()=>{
  chosenControl = 'keys';
  btnControlKey.classList.remove('ghost');
  btnControlKey.classList.add('selected');
  btnControlTouch.classList.add('ghost');
  btnControlTouch.classList.remove('selected');
});

btnControlTouch.addEventListener('click', ()=>{
  chosenControl = 'touch';
  btnControlTouch.classList.remove('ghost');
  btnControlTouch.classList.add('selected');
  btnControlKey.classList.add('ghost');
  btnControlKey.classList.remove('selected');
});

btnStart.addEventListener('click', startGame);

menuBack.addEventListener('click', ()=>{
  overlayMenu.style.display='none';
  setupPanel.style.display='block';
  document.getElementById('game-wrapper').style.display='none';
});

menuPlay.addEventListener('click', beginPlay);

btnFull.addEventListener('click', ()=>{
  const el = document.getElementById('game-wrapper');
  if(!document.fullscreenElement){
    el.requestFullscreen?.() || el.webkitRequestFullscreen?.();
  } else {
    document.exitFullscreen?.() || document.webkitExitFullscreen?.();
  }
});

btnShowScores.addEventListener('click', ()=>{
  updateScoresList();
  scoresPanel.style.display='block';
});

closeScores.addEventListener('click', ()=> scoresPanel.style.display='none');

btnClearScores.addEventListener('click', ()=>{
  if(confirm('Limpar todos os placares salvos?')){
    clearScores();
    updateScoresList();
    alert('Placar limpo!');
  }
});

goRestart.addEventListener('click', ()=>{
  overlayGameover.style.display='none';
  resetGame();
  GAME.player = createPlayer();
  
  if(GAME.control === 'touch'){
    touchLeft.style.display='flex';
    touchRight.style.display='flex';
  } else {
    touchLeft.style.display='none';
    touchRight.style.display='none';
  }
  
  GAME.running = true;
  GAME.lastTime = now();
  requestAnimationFrame(gameLoop);
});

goMenu.addEventListener('click', ()=>{
  overlayGameover.style.display='none';
  document.getElementById('game-wrapper').style.display='none';
  setupPanel.style.display='block';
  scoresPanel.style.display='none';
});

downloadJsonBtn.addEventListener('click', ()=> downloadJSON('scores-space-impact.json'));
downloadJsonBtn2.addEventListener('click', ()=> downloadJSON('scores-space-impact.json'));

function updateScoresList(){
  const arr = loadScores();
  if(arr.length === 0){
    scoresList.innerHTML = '<div class="score-row">Nenhum placar salvo ainda.</div>';
    return;
  }
  scoresList.innerHTML = '';
  arr.slice(0, 20).forEach((s)=>{
    const row = document.createElement('div');
    row.className = 'score-row';
    const left = document.createElement('div');
    left.textContent = `${s.nick} ‚Äî Fase ${s.level}`;
    const right = document.createElement('div');
    right.textContent = `${s.score} pts`;
    row.appendChild(left);
    row.appendChild(right);
    scoresList.appendChild(row);
  });
}

inputNick.addEventListener('input', ()=>{
  menuSub.textContent = `Nome: ${inputNick.value||'Player'} | Controle: ${chosenControl==='keys'?'Setas':'Toque'}`;
});

document.body.addEventListener('touchmove', function(e){
  if(GAME.running && GAME.control==='touch') e.preventDefault();
}, {passive:false});

updateScoresList();
updateHUD();

window.addEventListener('load', ()=>{
  btnControlKey.classList.add('selected');
});

</script>
</body>
</html>
  
